<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Zcash Trailing Finality Layer</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="introduction/a-path-to-pos-zcash.html"><strong aria-hidden="true">1.1.</strong> A Path to Proof-of-Stake Zcash</a></li><li class="chapter-item expanded "><a href="introduction/trailing-finality-layer-in-a-nutshell.html"><strong aria-hidden="true">1.2.</strong> Trailing Finality Layer in a Nutshell</a></li><li class="chapter-item expanded "><a href="introduction/status-and-next-steps.html"><strong aria-hidden="true">1.3.</strong> Status and Next Steps</a></li><li class="chapter-item expanded "><a href="introduction/motivating-finality.html"><strong aria-hidden="true">1.4.</strong> Motivating Finality</a></li><li class="chapter-item expanded "><a href="introduction/get-involved.html"><strong aria-hidden="true">1.5.</strong> Get Involved</a></li></ol></li><li class="chapter-item expanded "><a href="terminology.html"><strong aria-hidden="true">2.</strong> Terminology</a></li><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">3.</strong> Design Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="overview/design-goals.html"><strong aria-hidden="true">3.1.</strong> Design Goals</a></li><li class="chapter-item expanded "><a href="overview/design-at-a-glance.html"><strong aria-hidden="true">3.2.</strong> Design at a Glance</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Model Code Architecture</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Network Architecture</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Protocol Specification</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> Abstract Protocol</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.1.</strong> Token Dynamics</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> Concrete Protocol</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.1.</strong> Token Dynamics</div></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Security</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Abstract Analysis</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.1.</strong> Ebb-and-Flow analysis</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.2.</strong> Subprotocol Compromise Analysis</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.3.</strong> Model Code Architecture Analysis</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.4.</strong> Network Architecture Analysis</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.</strong> Concrete Analysis</div></li></ol></li><li class="chapter-item expanded "><a href="references.html"><strong aria-hidden="true">6.</strong> References</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Zcash Trailing Finality Layer</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="a-trailing-finality-layer-for-zcash"><a class="header" href="#a-trailing-finality-layer-for-zcash">A Trailing Finality Layer for Zcash</a></h1>
<p>This book introduces and specifies a <a href="./terminology.html#definition-tfl"><em>Trailing Finality Layer</em></a> for the Zcash network.</p>
<p>This design augments the existing Zcash Proof-of-Work (<a href="./terminology.html#definition-pow">PoW</a>) network with a new consensus layer which provides <a href="./terminology.html#definition-trailing-finality"><em>trailing finality</em></a>. This layer enables transactions included via PoW to become <a href="./terminology.html#definition-final"><em>final</em></a> which assures that they cannot be reverted by the protocol. This enables safer and simpler wallets and other infrastructure, and aids trust-minimized cross-chain bridges. This consensus layer uses <a href="./terminology.html#definition-pos"><em>Proof-of-Stake</em></a> consensus, and enables ZEC holders to earn protocol rewards for contributing to the security of the Zcash network. By integrating a PoS layer with the current PoW Zcash protocol, this design specifies a <a href="./terminology.html#definition-hybrid-consensus"><em>hybrid consensus</em></a> protocol dubbed <a href="./terminology.html#definition-pow-tfl">PoW+TFL</a>.</p>
<p>The rest of this introductory chapter is aimed at a general audience interested in the context of this proposal within Zcash development, status and next steps, motivations, a primer on finality, and tips to get involved.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="a-path-to-proof-of-stake-zcash"><a class="header" href="#a-path-to-proof-of-stake-zcash">A Path to Proof-of-Stake Zcash</a></h1>
<p>The <a href="introduction/../terminology.html#definition-tfl">TFL</a> design provides a possible first step in transitioning <a href="https://z.cash">Zcash</a> to a <a href="introduction/../terminology.html#definition-pos">PoS</a> protocol. Here we describe how a transition to PoS relates to &quot;the Zcash roadmap&quot; and how TFL fits into one approach to a PoS transition.</p>
<h2 id="the-zcash-tech-tree"><a class="header" href="#the-zcash-tech-tree">The Zcash Tech-Tree</a></h2>
<p>There are multiple developer orgs working on different proposed features for Zcash. Some of these involve multiple large distinct upgrade steps, and several of these steps depend on other such steps. This could be represented as a directed acyclic graph. We have begun referring to this space of possible future improvements as the <em>Zcash Tech-Tree</em>, taking inspiration from an analogous concept in gaming.<sup class="footnote-reference"><a href="#tech-tree-history">1</a></sup></p>
<p>We envision a <em>proof-of-stake transition path</em> as one of the potential paths within this tech-tree which is the primary protocol focus of this proposal. An example visualization of this Zcash Tech-Tree might look like this:</p>
<p><img src="introduction/a_path_to_proof_of_stake_zcash_0.generated.svg" alt="" /></p>
<h2 id="a-proof-of-stake-transition-path"><a class="header" href="#a-proof-of-stake-transition-path">A Proof-of-Stake Transition Path</a></h2>
<p>Given that context, we envision a path within the Zcash Tech-Tree for transitioning Zcash to PoS. At the top level we propose that this path contain at least two major milestones:</p>
<ol>
<li>Transitioning from current Zcash <a href="introduction/../terminology.html#definition-nu5">NU5</a> <a href="introduction/../terminology.html#definition-pow">PoW</a> protocol to a PoW/PoS <a href="introduction/../terminology.html#definition-hybrid-consensus">hybrid consensus</a> protocol dubbed <a href="introduction/../terminology.html#definition-pow-tfl">PoW+TFL</a>.</li>
<li>Transitioning from <a href="introduction/../terminology.html#definition-pow-tfl">PoW+TFL</a> to pure <a href="introduction/../terminology.html#definition-pow-tfl">PoS</a> protocol.</li>
</ol>
<p>After this transition to pure PoS, there are likely to be future improvements to the PoS protocol, or the consensus protocol more generally. This TFL book focuses almost exclusively on the first step in this sequence.</p>
<p>Our primary motivation for proposing (at least) two steps is to minimize disruption to usability, safety, security, and the ecosystem during each step.</p>
<p>This book primarily focuses this first step: the transition to <a href="introduction/../terminology.html#definition-pow-tfl">PoW+TFL</a>. To understand the specific goals for that, see <a href="introduction/../overview/design-goals.html">Design Goals</a>. </p>
<p>With this approach, the Zcash Tech Tree with the <a href="introduction/../terminology.html#definition-tfl">TFL</a> approach might look something like this:</p>
<p><img src="introduction/a_path_to_proof_of_stake_zcash_1.generated.svg" alt="" /></p>
<h2 id="why-two-steps"><a class="header" href="#why-two-steps">Why Two Steps?</a></h2>
<p>One question we've gotten in proposing this approach is why take a two-step process with an intermediate <a href="introduction/../terminology.html#definition-hybrid-consensus">hybrid consensus</a> protocol, rather than a single transition directly to a <a href="introduction/../terminology.html#definition-pos">PoS</a> protocol? </p>
<p>Here's how we think about those trade-offs:</p>
<h3 id="considering-single-transition-vs-hybrid-multi-step"><a class="header" href="#considering-single-transition-vs-hybrid-multi-step">Considering Single Transition (vs Hybrid Multi-Step)</a></h3>
<h4 id="pros"><a class="header" href="#pros">Pros</a></h4>
<ul>
<li>We already understand the current PoW protocol well, and if we transition to an existing proven PoS protocol, then we could skip the complexity of an intermediate hybrid stage.</li>
<li>The node implementation might be simpler.</li>
<li>Explaining to people what is happening might be simpler. Something like “Zcash has been PoW since it launched, but on $DATE (e.g. at block height X) it will switch to PoS.”</li>
<li>Given that the issuance in a given time period is bounded by the supply curve, the full amount that was previously allocated to mining rewards becomes immediately available for staking rewards at the switch-over, rather than having to share this amount between mining and staking during the hybrid stage.</li>
</ul>
<h4 id="cons"><a class="header" href="#cons">Cons</a></h4>
<ul>
<li>If there is any unforeseen show-stopping problem in the new protocol or the transition process, we’d have to react to a network-wide issue.</li>
<li>It may be more likely to cause ecosystem disruption; unforeseen differences between PoW and PoS might cause various kinds of snags or papercuts throughout the ecosystem, and these would all pop up around the same time, which may lead to a loss of confidence/retention/adoption or at the very least inconvenience many users for some time.</li>
<li>Losing miners: since the transition would be all at once, we may lose some number of miners, who are participants and users in the ecosystem. Miners may leave prior to the transition in order to take care of their own needs. If there is some show-stopper in the transition, one possible short-term mitigation would be to fall back on PoW which is well known, but if we’ve lost most miners, that may no longer be viable.</li>
</ul>
<h3 id="considering-hybrid-multi-step-approach-vs-single-step"><a class="header" href="#considering-hybrid-multi-step-approach-vs-single-step">Considering Hybrid Multi-Step approach (vs Single-Step):</a></h3>
<p>Note: TFL is one instance of a multi-step approach.</p>
<h4 id="pros-1"><a class="header" href="#pros-1">Pros</a></h4>
<ul>
<li>We can hopefully be less disruptive across the ecosystem so that there are fewer snags and disruptions with each step.</li>
<li>If there is a show-stopping flaw in any step, the fall-back possibility seems more plausible. For example, if there is a show-stopper when transitioning from PoW to <a href="introduction/../terminology.html#definition-pow-tfl">PoW+TFL</a>, falling back to pure PoW seems more feasible, since both protocols rely on mainnet PoW infrastructure, so those participants will be present in either case.</li>
<li>Retaining miners during a hybrid phase: while it is true that a hybrid protocol will lower miner revenue (since we aim to maintain the issuance schedule constraints), there is also more possibility and likelihood of keeping some of these users engaged. For example, they may begin participating in staking services (either as delegators or as infrastructure operators). If that is successful, then they’re also more likely to remain engaged in the subsequent transition to pure PoS.</li>
<li>This general approach was demonstrated successfully by Ethereum, which is the largest or second largest cryptocurrency network for several important metrics (e.g. market cap, fees paid, user and developer activity, …). So we know this can be done well without disruptions.</li>
</ul>
<h4 id="cons-1"><a class="header" href="#cons-1">Cons</a></h4>
<ul>
<li>The intermediate hybrid step will be a more novel and less well understood protocol. (It will necessarily be fairly different from Ethereum’s Beacon chain era.)</li>
<li>Consensus nodes will be more complex, involving logic for both sub-protocols as well as their integration. (Ideally this complexity can be modularized so that the nodes are easier to maintain and improve.)</li>
<li>This may be more complicated to explain to current and potential new users. Something like “Zcash launched as PoW, and on $DATE (block height X) it will transition to a hybrid system, then later to a pure PoS system.”</li>
<li>The available issuance must be shared between mining and staking rewards during the hybrid stage. The security of the PoW layer and of the PoS layer during this stage is partially dependent on the funds allocated to issuance for each protocol, and it is not yet clear to what extent splitting rewards would affect overall security.</li>
</ul>
<h1 id="footnotes"><a class="header" href="#footnotes">Footnotes</a></h1>
<div class="footnote-definition" id="tech-tree-history"><sup class="footnote-definition-label">1</sup>
<p>See <a href="https://en.wikipedia.org/wiki/Technology_tree#History">Wikipedia's Technology Tree - History</a> section for details.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="trailing-finality-layer-in-a-nutshell"><a class="header" href="#trailing-finality-layer-in-a-nutshell">Trailing Finality Layer in a Nutshell</a></h1>
<p>The hybrid PoW/PoS protocol proposed in this book is similar to today's Zcash NU5 protocol with the addition of a <em>Trailing Finality Layer</em>:</p>
<p><strong>TODO</strong>: Add graphic showing nodes connected to each other in the p2p protocol. Each node has two parts: PoW and TFL. Each part has a distinct connection to the neighbors of the same part, so node A's &quot;PoW&quot; connects to node B's &quot;PoW&quot;, node A's &quot;TFL&quot; connects to node B's &quot;TFL&quot;. Finally, we want some way to visualize that all of the PoW nodes and connections were &quot;pre-existing&quot; and that the TFL pieces are a &quot;new layer&quot;.</p>
<p>The Zcash Trailing Finality Layer refers to a new subprotocol of a new hybrid PoW/PoS protocol, which we refer to as <em>PoW+TFL</em>. This subprotocol introduces <a href="introduction/../terminology.html#definition-assured-finality">assured finality</a> for the Zcash blockchain, ensuring that <em>final</em> blocks (and the transactions within them) may never be rolled back.</p>
<p>We use the term &quot;layer&quot; because we can understand this design as introducing a new layer to the Zcash network, making only minimal changes to the existing network and consensus protocol. This modular separation is present in the consensus rules, the network protocol, and the code architecture.</p>
<h2 id="why-should-users-care"><a class="header" href="#why-should-users-care">Why Should Users Care?</a></h2>
<p>There are three categories of users this proposed TFL protocol would impact:</p>
<h3 id="current-zec-users"><a class="header" href="#current-zec-users">Current ZEC Users</a></h3>
<p>Existing ZEC users who are primarily concerned with storing or receiving ZEC, whether private or transparent may benefit from this change in the short or medium term, because it may help lower delay times for some services, such as exchange deposits. As exchanges come to rely on the new finality guarantee, they can often reduce their deposit wait times. Other services with similar confirmation-depth-based wait times can be improved in a similar way to lower these wait times. Other than this improvement, these users should notice no other changes.</p>
<p>In the longer term, providing finality will be useful in establishing trust-minimized bridges to other blockchains. We anticipate this can enable better connecting ZEC to the Defi ecosystem, and with the introduction of Zcash Shielded Assets, this can enable other assets to connect to the Zcash shielded pool.</p>
<h3 id="proof-of-stake-users"><a class="header" href="#proof-of-stake-users">Proof-of-Stake Users</a></h3>
<p>Users who are interested in providing finality infrastructure, or users who want to delegate ZEC towards finality, will be able to earn rewards from the protocol for doing so, while also taking on some risk to their funds (to prevent malicious abuse of the protocol). This may be an important new category of ZEC users and use cases.</p>
<h3 id="miners"><a class="header" href="#miners">Miners</a></h3>
<p>Miners who provide Proof-of-Work security will necessarily see some reduction in their block rewards, since this proposal maintains the same issuance schedule and supply cap of ZEC while also spending some rewards on finality.</p>
<p><strong>Important Note:</strong> The proportion and details of how much mining rewards will be impacted, and conversely how much finality/PoS providers will earn, are not yet specified in this proposal.</p>
<h2 id="why-is-this-a-good-approach-to-a-pos-transition"><a class="header" href="#why-is-this-a-good-approach-to-a-pos-transition">Why is this a Good Approach to a PoS Transition?</a></h2>
<p>This design is appealing as a safer first step in transitioning the Zcash protocol for multiple reasons:</p>
<h3 id="it-enables-proof-of-stake-mechanisms-conservatively"><a class="header" href="#it-enables-proof-of-stake-mechanisms-conservatively">It Enables Proof-of-Stake Mechanisms Conservatively</a></h3>
<p>This transition would enable PoS mechanisms, including the ability to operate PoS infratructure and delegate ZEC towards those providers to earn protocol rewards. While all PoS transitions would accomplish this, this approach does so in a conservative manner: it introduces these mechanics while striving to minimize the impact on existing use cases and protocol security.</p>
<p>In a sense, we can think of this approach as enabling the Zcash community to &quot;dip our toes in the PoS waters&quot; rather than diving in. If the results pan out well, it gives us confidence for further transitions. If we discover challenges, flaws, or risks, we anticipate their impact will be more limited since this is a more cautious transition step.</p>
<h3 id="minimal-use-case-disruption"><a class="header" href="#minimal-use-case-disruption">Minimal Use-Case Disruption</a></h3>
<p>In many cases, existing products, services, and tools can continue using the mainnet chain with no changes to code assuming they rely on existing consensus nodes. We view this as a major benefit which allows Zcash's existing user network effect to continue safely unperturbed.</p>
<p>There will be certain narrow exceptional areas if those products, services, or tools need to be precise in areas where the protocol has changed, such as mining/staking reward calculations, transaction formats (in particular any new PoS-related fields or logic), or chain rollback logic.</p>
<h3 id="modular-design"><a class="header" href="#modular-design">Modular Design</a></h3>
<p>By conceptualizing the TFL as a distinct &quot;layer&quot; or subprotocol, the consensus rules can be described in terms of two <a href="introduction/../terminology.html#definition-consensus-subprotocols">consensus subprotocols</a>, one embodying most of the current consensus logic of Zcash and another the TFL. These protocols interact through a <a href="introduction/../terminology.html#definition-hybrid-construction">hybrid construction</a>. See <a href="introduction/../overview/design-at-a-glance.html">Design at a Glance</a> to learn more about these distinct subprotocols.</p>
<p>Reasoning about the whole protocol can leverage analysis and understanding of each subprotocol and the hybrid construction somewhat independently due to this modular design. Note that although this design is modular, the hybrid construction may require modifications to the [PoW] and/or [PoS] subprotocols to protect safety and liveness properties. Nevertheless, the modularity still improves analysis and reasoning compared to a monolithic design.</p>
<p>Finally, since one subprotocol is very similar to the existing Zcash <a href="introduction/../terminology.html#definition-nu5">NU5</a> protocol, this lessens risk that the consensus properties within that subprotocol compromise current NU5 properties.</p>
<h3 id="modular-implementation"><a class="header" href="#modular-implementation">Modular Implementation</a></h3>
<p>In addition to the other benefits of protocol design modularity, we anticipate actual implementations can realize this modularity in code. This can help makes implementations more robust, easier to maintain, and more interoperable.</p>
<p>For example, we can envision a standardized interface between PoW &amp; TFL consensus components, enabling different development teams to provide these different components and for &quot;full node&quot; packagers to mix and match them. This is somewhat reminiscent of Ethereum's execution/consensus layer separation which we believe has shown great success in implementation team and product diversity.</p>
<h2 id="cracking-the-nutshell"><a class="header" href="#cracking-the-nutshell">Cracking the Nutshell</a></h2>
<p>In the rest of the introductory section of this book, we describe the status and next steps for the TFL proposal, provide a motivation for finality, and suggestions for getting involved.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="status-and-next-steps"><a class="header" href="#status-and-next-steps">Status and Next Steps</a></h1>
<p>This is an early and incomplete protocol design proposal. It has not been well vetted for feasibility and safety. It has not had broad review from the Zcash community, so its status on any Zcash roadmap is undetermined.</p>
<h2 id="current-components"><a class="header" href="#current-components">Current Components</a></h2>
<h3 id="this-book"><a class="header" href="#this-book">This Book</a></h3>
<p>This book is intended to become both a high-level overview and introduction to <a href="introduction/../terminology.html#definition-tfl">TFL</a>, and a full specification.</p>
<h3 id="crosslink"><a class="header" href="#crosslink">Crosslink</a></h3>
<p>The current heart of the design work is an in-progress hybrid consensus protocol construction called <a href="introduction/../terminology.html#definition-crosslink">Crosslink</a>. This is an in-development realization of the <a href="introduction/../terminology.html#definition-tfl">TFL</a> design goals. The essential design details are specified, along with a security argument for its <a href="introduction/../terminology.html#definition-liveness">liveness</a>. The security argument for its <a href="introduction/../terminology.html#definition-liveness">safety</a> is in progress.</p>
<p>The draft specification and security arguments of Crosslink currently live on <a href="https://hackmd.io/JqENg--qSmyqRt_RqY7Whw?view">this hackmd</a>.</p>
<h3 id="simtfl"><a class="header" href="#simtfl"><code>simtfl</code></a></h3>
<p>We've begun creating a simulator called <a href="introduction/../terminology.html#definition-simtfl"><code>simtfl</code></a> which we will use to model security and abstract performance concerns. Its development is tracked at <a href="https://github.com/zcash/simtfl">https://github.com/zcash/simtfl</a>.</p>
<h2 id="major-missing-components"><a class="header" href="#major-missing-components">Major Missing Components</a></h2>
<ul>
<li>PoS subprotocol selection,</li>
<li>Issuance and supply mechanics, such as how much ZEC stakers may earn,</li>
<li>Integrated Zcash transaction semantics,</li>
<li>A transition plan from current Zcash mainnet to this protocol design,</li>
<li><a href="introduction/../terminology.html#definition-zip">ZIP</a>s specifying the above to the level of specificity required by ZIPs,</li>
<li>Security and safety analyses,</li>
<li>Economic analyses.</li>
</ul>
<p>This list may be incomplete, and as the design matures the need for major new components may be revealed.</p>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>This design proposal is being developed by <a href="https://electriccoin.co/">Electric Coin Company</a> as the first major milestone in our focus of deploying Proof-of-Stake to the Zcash protocol. Our rough near-term plan for this proposal is as follows:</p>
<ol>
<li>Complete the <a href="introduction/../terminology.html#definition-crosslink">Crosslink</a> description.</li>
<li>Complete core security arguments for <a href="introduction/../terminology.html#definition-crosslink">Crosslink</a>.</li>
<li>Define the <a href="introduction/status-and-next-steps.html#major-missing-components">Major Missing Components</a> above, including considerations such as issuance mechanics and Proof-of-Stake mechanisms.</li>
<li>Complete auxillary security arguments and analyses, such as specific attack scenarios, game-theoretic security, and so forth.</li>
<li>Mature <a href="introduction/../terminology.html#definition-simtfl"><code>simtfl</code></a> to analyze all cases of interest.</li>
<li>Follow the general Zcash process for proposal/review/refinement, including proposing one or more <a href="introduction/../terminology.html#definition-zip">ZIP</a>s.</li>
<li>Follow the general Zcash governance process for proposal review and refinement.</li>
<li>If accepted, productionize the proposal in ECC products and collaborate with other implementors who implement the proposal.</li>
<li>Celebrate when and if the proposal is activated on Mainnet. 🎉</li>
</ol>
<p>The fine-grained day-to-day goals and tasks for this project are present in <a href="https://zcash.github.io/developers">the Zcash Developers Hub</a> in the <a href="https://zcash.github.io/developers/zcash-tfl-dag">TFL-focused DAG</a>.</p>
<p>Please also see <a href="introduction/./get-involved.html">Get Involved</a> if you are interested in tracking this progress more closely, or in contributing.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="motivating-finality"><a class="header" href="#motivating-finality">Motivating Finality</a></h1>
<p>In Zcash currently, consensus relies solely on PoW, which only provides <em>probabilistic finality</em>, rather than <a href="introduction/../terminology.html#definition-assured-finality"><em>assured finality</em></a>.<sup class="footnote-reference"><a href="#finality-qualifiers">1</a></sup> This style of consensus does not offer a guarantee that any given block may not be <em>rolled back</em> which may invalidate the transactions it contains. Instead, the probability that a block may be rolled back decreases as more blocks are mined subsquently on top of it.<sup class="footnote-reference"><a href="#pow-rollback-security-assumptions">2</a></sup></p>
<p>Let's walk through an example of how Zcash's current PoW with probabilistic finality can impede important use cases. Consider a PoW node which sees this block sequence at time <code>T=0</code>:</p>
<p><img src="introduction/motivating_finality_0.generated.svg" alt="" /></p>
<p>When should a user, wallet, or other system choose to act based on a transaction in a block?</p>
<p>For this example, let's assume a bridging system may have received a deposit for <code>ZEC</code> in block <code>f</code> and issued a corresponding number of proxy tokens on a different network.</p>
<p>At a later time, <code>T=1</code>, this same node may see a longer PoW chain which invalidates some previously seen blocks:</p>
<p><img src="introduction/motivating_finality_1.generated.svg" alt="" /></p>
<p>The node has observed a longer chain ending at block <code>h'</code>, so PoW consensus calls for that new sequence to be treated as consensus. The previously seen blocks <code>f</code> and <code>g</code> are no longer part of the consensus history, and have been rolled back.</p>
<h2 id="impact-of-the-rollback"><a class="header" href="#impact-of-the-rollback">Impact of the Rollback</a></h2>
<p>In our example, the bridging system acted in response to a transaction in the original block <code>f</code> at <code>T=0</code>. If the new sequence ending at <code>h'</code> no longer contains the deposit to the bridging system, the integrity of the bridge has been violated<sup class="footnote-reference"><a href="#txn-rollback">3</a></sup>; the associated proxy tokens may have already been used in a complex chain of Defi applications or deposited onto an exchange and sold, which would make any recovery impossible. The proxy tokens on the other network no longer correspond to the correct amount of <code>ZEC</code> on the Zcash network.</p>
<h2 id="rollback-complications"><a class="header" href="#rollback-complications">Rollback Complications</a></h2>
<p>This example demonstrates how a lack of assured finality can impede many useful real-world scenarios. In practice, systems and services which need greater assurances wait for more block confirmations.</p>
<p>This has several drawbacks:</p>
<ul>
<li>it <em>doesn't remove the vulnerability</em>, it only reduces the likelihood;</li>
<li>different applications/services may require different block depths, making it difficult to compose or chain together different applications/services;</li>
<li>different block depth policies potentially confuse users, i.e. &quot;why do I have to wait one hour for my deposit in this exchange, but only 30 minutes on that exchange?&quot;; and</li>
<li>it introduces a long delay which inhibits many useful applications.</li>
</ul>
<p>In addition to these user-facing and economic drawbacks, correctly handling rollbacks makes the code for nodes, wallets, and other infrastructure more complex. Worse still, many systems may not have correct behavior for rollbacks at different depths, and since large rollbacks are rarer, these implementation flaws may not surface until there is a large rollback. While a large rollback would be disruptive all by itself, it becomes even worse when previously undiscovered bugs exacerbate the situation.</p>
<h2 id="trailing-finality-benefits"><a class="header" href="#trailing-finality-benefits">Trailing Finality Benefits</a></h2>
<p>Trailing finality extends the existing PoW consensus so that older blocks become final, assuring they <em>cannot</em> be rolled back, and by extension neither can any of the transactions they contain.</p>
<p>This directly addresses the first two flaws above: it completely removes the vulnerability, and it ensures all systems that need finality behave consistently with each other.</p>
<p>As for delay, trailing finality also introduces delay since final blocks &quot;trail behind&quot; the most recent PoW blocks. This can be an improvement for some applications, depending on their latency requirements. For example, if the delay to finality averages around 10 minutes, then this would enable an improvement for an exchange that requires 60 minutes of PoW blocks for a deposit. On the other hand, it would not be an improvement for an application that needs finality faster than 10 minutes.</p>
<p>Finally, implementations can be simplified by relying on the guarantee of finality. For example, a wallet can describe any transaction as pending or final, and does not need to provide difficult and potentially confusing UX (and the supporting database sophistication) for handling rollbacks.</p>
<h1 id="footnotes-1"><a class="header" href="#footnotes-1">Footnotes</a></h1>
<div class="footnote-definition" id="finality-qualifiers"><sup class="footnote-definition-label">1</sup>
<p>Throughout this book, when we say <em>finality</em> or <em>final</em> without other qualifiers, we specifically are referring to <em>assured finality</em> or a <em>assured final</em> block. Where we call out <em>probabalistic finality</em> we always use that qualifier.</p>
</div>
<div class="footnote-definition" id="pow-rollback-security-assumptions"><sup class="footnote-definition-label">2</sup>
<p>The estimated probability of a rollback relies on a variety of PoW security assumptions, and can be violated in various conditions, such as in mining efficiency breakthroughs, compromises of the PoW challenge algorithm (e.g. hash function collision resistance failure), difficulty-adjustment-algorithm failures, sudden/surprise mining capacity increases, and so on. So the estimated probability can be violated in potential &quot;black swan&quot; events.</p>
</div>
<div class="footnote-definition" id="txn-rollback"><sup class="footnote-definition-label">3</sup>
<p>This discussion simplifies consideration of <em>transaction rollback</em> vs <em>block rollback</em>. When a block is rolled back, it is possible for some of the transactions contained in it to appear in new canonical blocks. The conditions when this can occur vs when it cannot are multifaceted and also subject to malicious influence, so for simplicity we assume all transactions within a rolled-back block are also rolled back.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="get-involved"><a class="header" href="#get-involved">Get Involved</a></h1>
<p>We welcome contributions!</p>
<p>There are a variety of ways to contribute to this project:</p>
<h2 id="github"><a class="header" href="#github">Github</a></h2>
<p>If you have a GitHub account, you can get hands-on via <a href="https://github.com/nathan-at-least/tfl-book">the GitHub repository</a> for this book, including:</p>
<ul>
<li><a href="https://github.com/nathan-at-least/tfl-book/issues/new?assignees=nathan-at-least&amp;labels=question&amp;projects=&amp;template=question.yml">Ask a Question</a> - all questions welcome from basics to in-depth.</li>
<li><a href="https://github.com/nathan-at-least/tfl-book/issues/new?assignees=nathan-at-least&amp;labels=improvement&amp;projects=&amp;template=improvement.yml">Suggest an Improvement</a> to the content: anything from typo fixes to major design change proposals.</li>
<li><a href="https://github.com/nathan-at-least/tfl-book/issues/new?assignees=nathan-at-least&amp;labels=infrastructure&amp;projects=&amp;template=infrastructure.yml">Report Rendering / Infrastructure Issues</a> in case you're having trouble reading the content, viewing diagrams, rendering on your own computer, etc…</li>
</ul>
<h2 id="zcash-forum"><a class="header" href="#zcash-forum">Zcash Forum</a></h2>
<p><a href="https://forum.zcashcommunity.com/">The Zcash Forum</a> is a hangout for many Zcash enthusiasts. This is a good spot for more open-ended discussion about this design proposal, alternatives, and other developments in Zcash.</p>
<h2 id="zcash-rd-discord"><a class="header" href="#zcash-rd-discord">Zcash R&amp;D Discord</a></h2>
<p>You can catch us on <a href="https://discord.gg/U26xq3R2">the Zcash R&amp;D Discord</a> in this <a href="https://discord.com/channels/809218587167293450/826162958027063377"><code>#proof-of-stake</code> channel</a>.</p>
<h2 id="zcash-arborist-calls"><a class="header" href="#zcash-arborist-calls">Zcash Arborist Calls</a></h2>
<p>The <a href="https://zfnd.org/arborist-calls/">Zcash Arborist Calls</a> are bi-weekly Zcash protocol development calls, where proposals like this are discussed. Feel free to come lurk, ask questions, or provide feedback or suggestions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="terminology"><a class="header" href="#terminology">Terminology</a></h1>
<p>This book relies on the following terminology. We strive to keep these definitions as precise as possible and their definitions may deviate from uses elsewhere.</p>
<p>Definitions are sorted alphabetically.</p>
<h2 id="terms"><a class="header" href="#terms">Terms</a></h2>
<!-- Unlike true html, it seems `mdbook` requires the span tags to be empty and immediately pre-fix the intended anchor target. -->
<p><span id="definition-assured-finality"></span>
<strong>Assured Finality</strong>: A protocol property that assures that transactions cannot be reverted by that protocol. As with all protocol guarantees, a protocol assumes certain conditions must be met. A transaction may either be final or not: transactions which are not final may not become final, whereas once transactions do achieve finality they retain that property indefinitely (so long as protocol requirements are met).</p>
<p>Importantly, it is not feasible for any protocol to prevent reversing final transactions &quot;out of band&quot; from the protocol, such as if a sufficiently large and motivated group of users forks the network to include a specific new validity rule reverting transactions. In some cases this might be desirable, for example to mitigate exploitation of a security flaw. We are investigating the implications for governance and how to incorporate such situations into our security model. In any case, for this reason we eschew the term &quot;absolute finality&quot; sometimes used in technical discussions about consensus protocols.</p>
<p><span id="definition-consensus-subprotocols"></span>
<strong>Consensus Subprotocols</strong>: The <a href="terminology.html#definition-pow">PoW</a> and <a href="terminology.html#defintion-pos">PoS</a> subprotocols in <a href="terminology.html#definition-pow-tfl">PoW+TFL</a> or other <a href="terminology.html#definition-hybrid-consensus">hybrid protocols</a>.</p>
<p><span id="definition-crosslink"></span>
<strong>Crosslink</strong>: A <a href="terminology.html#definition-hybrid-construction">hybrid construction</a> consensus protocol striving to implement the <a href="terminology.html#definition-tfl">TFL</a> design goals. See <a href="./introduction/status-and-next-steps.html#current-components">Status and Next Steps: Current Components</a> for current status.</p>
<p><span id="definition-final"></span>
<strong>Final</strong>: A protocol property of transactions. In this book, this always implies <a href="terminology.html#definition-assured-finality">assured finality</a>, in contrast to concepts like &quot;probabilistic finality&quot; provided by <a href="terminology.html#definition-pow">PoW</a>.</p>
<p><span id="definition-hybrid-consensus"></span>
<strong>Hybrid Consensus</strong>: A consensus protocol that integrates more than one consensus subprotocol. <a href="terminology.html#definition-pow-tfl">PoW+TFL</a> is an instance of a hybrid protocol integrating <a href="terminology.html#definition-pow">PoW</a> and <a href="terminology.html#definition-pos">PoS</a> protocols.</p>
<p><span id="definition-hybrid-construction"></span>
<strong>Hybrid Construction</strong>: The design component of a <a href="terminology.html#defintion-hybrid-consensus">hybrid consensus</a> which specifies how to integrate <a href="terminology.html#definition-consensus-subprotocols">subprotocols</a> and what modifications, if any, those subprotocols need to be safely integrated. Examples include <a href="terminology.html#definition-crosslink">Crosslink</a> and <a href="terminology.html#definition-snap-and-chat">Snap-and-Chat</a>.</p>
<p><span id="definition-liveness"></span>
<strong>Liveness</strong>: The property of a distributed protocol which ensures that the protocol may progress provided liveness requirements are met. <strong>TODO:</strong> Fix this definition, which begs the question by failing to define &quot;progress&quot;.</p>
<p><span id="definition-nu5"></span>
<strong>NU5</strong>: The Zcash consensus protocol as of NU5.<sup class="footnote-reference"><a href="#new-mainnet-precursors">1</a></sup></p>
<p><span id="definition-objective-validity"></span>
<strong>Objective Validity</strong>: A validity property of a protocol history (such as a ledger) which can be computed purely from that history with no other context. Objective validity is needed to define consensus rules that will lead to the same protocol state being eventually agreed on by all nodes.</p>
<p><span id="definition-pos"></span>
<strong>Proof-of-Stake</strong>: A PoS protocol achieves consensus on transaction status by taking into account the weighting of staking tokens. PoS protocols exist under a large umbrella and may or may not provide <a href="terminology.html#definition-assured-finality">assured finality</a> or other properties this design requires of <a href="terminology.html#definition-tfl">TFL</a>.</p>
<p><span id="definition-pow"></span>
<strong>Proof-of-Work</strong>: A PoW protocol uses Nakamoto consensus pioneered by Bitcoin. The PoW subprotocol within PoW+TFL is a different consensus protocol from <a href="terminology.html#definition-nu5">NU5</a> and encompasses more than narrow Nakamoto PoW consensus, including transaction semantics such as for shielded transfers.</p>
<p><span id="definition-pow-tfl"></span>
<strong>PoW+TFL</strong>: the overall complete, integrated consensus protocol specified in this book.</p>
<p><span id="definition-safety"></span>
<strong>Safety</strong>: The property of a distributed protocol that guarantees a participant may safely rely on a consistent local state, provided safety requirements are met. <strong>TODO:</strong> Fix this definition.</p>
<p><span id="definition-simtfl"></span>
<strong><code>simtfl</code></strong>: a protocol simulator for analyzing <a href="terminology.html#definition-tfl">TFL</a> security and abstract performance. Development lives at <a href="https://github.com/zcash/simtfl">https://github.com/zcash/simtfl</a></span>. See <a href="./introduction/status-and-next-steps.html#current-components">Status and Next Steps: Current Components</a> for current status.</p>
<p><span id="definition-snap-and-chat"></span>
<strong>Snap-and-Chat</strong>: A <a href="terminology.html#definition-hybrid-construction">hybrid construction</a> consensus protocol introduced in <a href="./references.html#ebb-and-flow-protocols">Ebb-and-Flow Protocols</a>.</p>
<p><span id="definition-tfl"></span>
<strong>TFL</strong>: The <em>Trailing Finality Layer</em> subprotocol within PoW+TFL. This is a new <a href="terminology.html#definition-pos">PoS</a> subprotocol which provides <a href="terminology.html#definition-assured-finality">assured finality</a> for Zcash.</p>
<p><span id="definition-trailing-finality"></span>
<strong>Trailing Finality</strong>: A protocol property wherein transactions become final some time after first appearing in <a href="terminology.html#definition-pow">PoW</a> blocks.</p>
<p><span id="definition-zip"></span>
<strong>ZIP</strong>: a Zcash Improvement Proposal is the protocol development process the Zcash community uses to safely define potential protocol improvements. See <a href="https://zips.z.cash">https://zips.z.cash</a></span>.</p>
<p><em>TODO</em>: Clarify the distinctions between PoW (general consensus), <a href="terminology.html#definition-nu5">NU5</a> which includes transaction semantics, and the PoW component of <a href="terminology.html#definition-pow-tfl">PoW-TFL</a>. These distinctions deserve unique terms.</p>
<h1 id="footnotes-2"><a class="header" href="#footnotes-2">Footnotes</a></h1>
<div class="footnote-definition" id="new-mainnet-precursors"><sup class="footnote-definition-label">1</sup>
<p>If new consensus changes are deployed to Zcash mainnet prior to PoW+TFL design finalization, this design must be updated to refer to the new delta (e.g. by reanalyzing all changes against NU6 or NU7, etc…)</p>
</div>
<!-- This trailing whitespace ensures that readers who follow a link to a definition will always see that term at the top of their view. -->
<pre>







































</pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design-overview"><a class="header" href="#design-overview">Design Overview</a></h1>
<p>This design augments the existing Zcash Proof-of-Work (PoW) network with a new consensus layer which provides <em>trailing finality</em>, called the <em>Trailing Finality Layer (TFL)</em>.</p>
<p>This layer enables blocks produced via PoW to become <em>final</em> which ensures they may never be rolled back. This enables safer and simpler wallets and other infrastructure, and aids trust-minimized cross-chain bridges.</p>
<p>This consensus layer uses a finalizing <em>Proof-of-Stake (PoS)</em> consensus protocol, and enables ZEC holders to earn protocol rewards for contributing to the security of the Zcash network. By integrating a PoS layer with the current PoW Zcash protocol, this design specifies a <em>hybrid consensus protocol</em>.</p>
<p>The integration of the current PoW consensus with the TFL produces a new top-level consensus protocol referred to as <em>PoW+TFL</em>.</p>
<p>In the following subchapters we introduce the <a href="./overview/design-at-a-glance.html">Design at a Glance</a>, then provide an overview of the major components of the design.</p>
<p>Following this overview chapter, we proceed into a detailed <a href="">Protocol Specification (TODO)</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design-goals"><a class="header" href="#design-goals">Design Goals</a></h1>
<p>Here we strive to lay out our high level TFL design goals.</p>
<h2 id="goals-design-and-trade-offs"><a class="header" href="#goals-design-and-trade-offs">Goals, Design, and Trade-offs</a></h2>
<p>Here we lay out <em>ideal</em> goals. As we develop a complete design, we are likely to inevitably encounter trade-offs some of which may preclude achieving the full idealized goals. Wherever possible, we motivate design decisions by these goals, and when goals are impacted by trade-offs we describe that impact and the rationale for the trade-off decision.</p>
<p>For example, one ideal user experience goal below is to avoid disruption to existing wallets. However, the <a href="overview/../terminology.html#definition-crosslink">Crosslink</a> construction may require wallets to to alter their context of valid transactions differently from the current <a href="overview/../terminology.html#definition-nu5">NU5</a> protocol.</p>
<h2 id="user-experience-and-use-case-goals"><a class="header" href="#user-experience-and-use-case-goals">User Experience and Use Case Goals</a></h2>
<p>We strive to start our protocol design process from user experience (UX) and use case considerations foremost, since at the end of the day all that matters in a protocol is what user needs it meets and how well.</p>
<ul>
<li>All currently supported wallet user experience should continue to operate seamlessly without change during or after protocol transitions. This covers the use of addresses, payment flow, transfers, ZEC supply cap and issuance rate, backup/restore, and other features users currently rely on.</li>
<li>There must be no security or safety degradation due to wallet user behavior introduced by PoS transitions, assuming users follow their current behaviors unchanged and continue to use the same cognitive model of the impacts of their behaviors. This goal encompasses all of security and safety, including privacy and transparency or more explicit disclosures.</li>
<li>The protocol should enable users of shielded mobile wallets to delegate ZEC to PoS consensus providers and earn a return on that ZEC coming via ZEC issuance or fees. Doing this may expose users to a risk of loss of delegated ZEC (such as through “slashing fees”). The protocol must guarantee that PoS consensus providers have no discretionary control over such delegated funds (including that they cannot steal those funds).</li>
<li>For any hybrid PoW/PoS protocol (including the PoW+TFL protocol we’re proposing), the process and UX of mining remains unchanged except that the return on investment may be altered. This is true both of consensus level block miners (ie mining pools and solo miners) and mining pool participants.</li>
<li>Any hybrid PoW/PoS protocol (including PoW+TFL) block explorers will continue to function with the same UX through transitions in-so-far as displaying information about transactions, the mempool, and blocks.</li>
<li>Block explorers and other network metrics sites may require UX changes with respect to mining rewards and issuance calculations.</li>
<li>Network metrics sites may require UX changes with respect to the p2p protocol or other network-specific information.</li>
<li>Users can rely on <a href="overview/../terminology.html#definition-assured-finality">assured finality</a> with an expected time-to-finality of &lt;30m.<sup class="footnote-reference"><a href="#req-ttf-30m">1</a></sup></li>
</ul>
<h2 id="developer-experience-goals"><a class="header" href="#developer-experience-goals">Developer Experience Goals</a></h2>
<p>For a full PoS transition, ecosystem developers for products such as consensus nodes, wallets, mining services, chain analytics, and more will certainly need to update their code to support transitions. However, we carve out a few goals as an exception to this for this category of users:</p>
<ul>
<li>Wallet developers should not be required to make any changes through protocol transitions as long as they rely solely on the lightwalletd protocol or a full node API (such as the zcashd RPC interface).</li>
<li>For any hybrid PoW/PoS protocol (including PoW+TFL), mining pools and miners should not be required to make any software or protocol changes as long as they rely on zcashd-compatible GetBlockTemplate. One exception to this is software that bakes in assumptions about the block reward schedule, rather than relying on GetBlockTemplate solely.</li>
</ul>
<h2 id="safety-security-and-privacy-goals"><a class="header" href="#safety-security-and-privacy-goals">Safety, Security, and Privacy Goals</a></h2>
<p>Zcash has always had exemplary safety, security, and privacy, and we aim to continue that tradition:</p>
<ul>
<li>For any hybrid PoW/PoS protocol (including PoW+TFL), the cost-of-attack for a 1-hour rollback should not be reduced, given a “reasonably rigorous” security argument.</li>
<li>For any hybrid PoW/PoS protocol (including PoW+TFL), the cost-of-attack to halt the chain should be larger than the 24 hour revenue of PoW mining rewards, given a “reasonably rigorous” security argument.</li>
</ul>
<p>TODO: privacy, pure-PoS security goals.</p>
<h2 id="design-conservatism-goals"><a class="header" href="#design-conservatism-goals">Design Conservatism Goals</a></h2>
<p>We want to follow some conservative design heuristics to minimize risk and mistakes:</p>
<ul>
<li>Rely as much as possible on design components that are already proven in production environments.</li>
<li>Rely as much as possible on design components with adequate theoretical underpinnings and security analyses.</li>
<li>Minimize changes or variations on the above: strive to only alter existing work when necessary for overall design goals. For example, Zcash's privacy or issuance constraints are likely less common among existing PoS designs.</li>
</ul>
<h1 id="non-goals"><a class="header" href="#non-goals">Non-goals</a></h1>
<p>These are not goals of the TFL design, either to simplify the scope of the initial design (a.k.a. <a href="overview/design-goals.html#out-of-scope-goals">Out-of-Scope Goals</a>), or because we believe some potential goal <em>should not</em> be supported (a.k.a. <a href="overview/design-goals.html#anti-goals">Anti-goals</a>).</p>
<h2 id="out-of-scope-goals"><a class="header" href="#out-of-scope-goals">Out-of-Scope Goals</a></h2>
<p>While these desiderata may be common across the blockchain consensus design space, they are not specific goals for the initial TFL design. Note that these may be goals for future protocol improvements.</p>
<ul>
<li>
<p>Prioritizing minimal time-to-finality over other considerations (such as protocol simplicity, impact on existing use cases, or other goals above).</p>
</li>
<li>
<p>In-protocol liquid staking derivatives.</p>
</li>
<li>
<p>Maximizing the PoS staked-voter count ceiling. For example, <a href="https://github.com/tendermint/tendermint#research">Tendermint BFT</a> has a relatively low ceiling of ~hundreds of staked voters, whereas Ethereum's <a href="https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/gasper/">Gasper</a> supports hundreds of thousands of staked voters.</p>
</li>
<li>
<p>Reducing energy usage. While this would presumably be a goal of a pure PoS transition, it likely cannot be achieved for hybrid PoW/PoS without loss of security.</p>
</li>
</ul>
<h2 id="anti-goals"><a class="header" href="#anti-goals">Anti-Goals</a></h2>
<p>Distinctly from <a href="overview/design-goals.html#out-of-scope-goals">Out-of-Scope Goals</a> we track &quot;anti-goals&quot; which are potential goals that we <em>explicitly reject</em>, which are potential goals we aim to <em>not</em> support even in future protocol improvements.</p>
<p>We currently have no defined anti-goals.</p>
<h1 id="footnotes-3"><a class="header" href="#footnotes-3">Footnotes</a></h1>
<div class="footnote-definition" id="req-ttf-30m"><sup class="footnote-definition-label">1</sup>
<p>This requirement comes from <a href="https://github.com/Electric-Coin-Company/tfl-book/issues/38">a request from a DEX developer</a>. While we have not yet surveyed DEX and Bridge designs, we're relying on this as a good starting point.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design-at-a-glance"><a class="header" href="#design-at-a-glance">Design at a Glance</a></h1>
<p>The <a href="overview/../terminology.html#definition-pow-tfl">PoW+TFL</a> consensus protocol is logically an extension of the Zcash consensus rules to introduce <a href="overview/../terminology.html#definition-trailing-finality">trailing finality</a>. This is achieved by compartmentalizing the top-level PoW+TFL protocol into two <a href="overview/../terminology.html#definition-consensus-subprotocols">consensus subprotocols</a>, one embodying most of the current consensus logic of Zcash and another the TFL. These protocols interact through a <a href="overview/../terminology.html#definition-hybrid-construction">hybrid construction</a>, which specifies how the protocols interact, and what changes from &quot;off-the-shelf&quot; behavior, if any, need to be imposed on the subprotocols. Each of these components (the two subprotocols and the hybrid construction) are somewhat modular: different subprotocols or hybrid constructions may be combined (with some modification) to produce a candidate <a href="overview/../terminology.html#definition-pow-tfl">PoW+TFL</a> protocol.</p>
<p><strong>TODO:</strong> Add consensus subprotocol diagram.</p>
<h2 id="hybrid-construction"><a class="header" href="#hybrid-construction">Hybrid Construction</a></h2>
<p>The <a href="overview/../terminology.html#definition-hybrid-construction">hybrid construction</a> is a major design component of the full consensus protocol which specifies how the subprotocols integrate. So far we have considered three candidates:</p>
<ol>
<li>The implied/loosely defined hybrid construction <a href="https://www.youtube.com/watch?v=qhMzMYeEPMM&amp;list=PL40dyJ0UYTLII7oQRQmNOFf0d2iKT35tL&amp;index=17">presented at Zcon4</a>.</li>
<li>The <a href="overview/../terminology.html#definition-snap-and-chat">Snap-and-Chat</a> from the <a href="https://eprint.iacr.org/2020/1091">Ebb-and-Flow paper</a>.</li>
<li>The <a href="overview/../terminology.html#definition-crosslink">Crosslink</a> construction.</li>
</ol>
<p>Currently we believe <a href="overview/../terminology.html#definition-crosslink">Crosslink</a> is the best candidate, due to security considerations.</p>
<p><strong>TODO:</strong> Clarify the security considerations at a high level.</p>
<h2 id="subprotocols"><a class="header" href="#subprotocols">Subprotocols</a></h2>
<p>The PoW+TFL hybrid consensus consists of two interacting subprotocols:</p>
<ol>
<li><a href="overview/../terminology.html#definition-pow">PoW Subprotocol</a>: this subprotocol is very similar to NU5 consensus. It is a design goal of the TFL design to minimize changes to this subprotocol. Note: the shorthand &quot;PoW&quot; is potentially misleading, because this subprotocol is also responsible for the bulk of all supply and transaction semantic consensus rules.</li>
<li><a href="overview/../terminology.html#definition-pos">PoS Subprotocol</a>: this is a new subprotocol which provides trailing finality via a finalizing PoS protocol.</li>
</ol>
<p><strong>TODO:</strong> Find a more precise name for the PoW subprotocol, because this subprotocol is responsible for:</p>
<ul>
<li>Proof-of-Work proving/validation (unmodified)</li>
<li>Nakamoto Best-chain Fork Choice rule (potentially modified by the <a href="overview/../terminology.html#definition-hybrid-construction">hybrid construction</a>)</li>
<li>Transaction Validity Rules (with a <a href="overview/../terminology.html#definition-hybrid-construction">transaction context</a> potentially modified by <a href="overview/../terminology.html#definition-hybrid-construction">hybrid construction</a>)</li>
</ul>
<p>Note that the <a href="overview/../terminology.html#definition-hybrid-construction">hybrid construction</a> may require modification to the &quot;off-the-shelf&quot; versions of these subprotocols. In particular <a href="overview/../terminology.html#definition-crosslink">Crosslink</a> requires each protocol to refer to the state of the other to provide <a href="overview/../terminology.html#definition-objective-validity">objective validity</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="references"><a class="header" href="#references">References</a></h1>
<h2 id="ebb-and-flow-protocols"><a class="header" href="#ebb-and-flow-protocols">Ebb-and-Flow Protocols</a></h2>
<p><a href="https://arxiv.org/abs/2009.04987">Ebb-and-Flow Protocols: A Resolution of the Availability-Finality Dilemma</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
